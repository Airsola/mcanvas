!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).MCanvas=e()}(this,function(){"use strict";function o(t){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function d(n){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{},e=Object.keys(a);"function"==typeof Object.getOwnPropertySymbols&&(e=e.concat(Object.getOwnPropertySymbols(a).filter(function(t){return Object.getOwnPropertyDescriptor(a,t).enumerable}))),e.forEach(function(t){var e,i,o;e=n,o=a[i=t],i in e?Object.defineProperty(e,i,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[i]=o})}return n}function k(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var i=[],o=!0,n=!1,a=void 0;try{for(var r,s=t[Symbol.iterator]();!(o=(r=s.next()).done)&&(i.push(r.value),!e||i.length!==e);o=!0);}catch(t){n=!0,a=t}finally{try{o||null==s.return||s.return()}finally{if(n)throw a}}return i}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}var j={extend:function(o,t){var n=this,e=this.isType(t);if("object"==e)this.forin(t,function(t,e){var i=n.isType(e);"object"!==i&&"array"!==i?o[t]=e:(n.isType(o[t])===i&&null!==o[t]||(o[t]="object"==i?{}:[]),n.extend(o[t],e))});else if("array"==e)for(var i=0;i<t.length;i++)o[i]=t[i];else o=t;return o},loadImage:function(t,e,i){var o=new Image;0==t.indexOf("http")&&(o.crossOrigin="*"),o.onload=function(){e(o),setTimeout(function(){o=null},1e3)},o.onerror=function(){i("img load error")},o.src=t},isObject:function(t){return this.isObjFunc(t,"Object")},isBoolean:function(t){return this.isObjFunc(t,"Boolean")},isArr:function(t){return this.isObjFunc(t,"Array")},getImage:function(t,e,i){if("string"==typeof t)this.loadImage(t,function(t){e(t)},i);else{if("object"!=o(t))return void console.log("add image error");e(t)}},forin:function(t,e){for(var i in t)t.hasOwnProperty(i)&&e(i,t[i])},isIos8:function(){var t=window.navigator.userAgent.toLowerCase(),e=/(iPhone|iPad|iPod|iOS)/gi.test(t),i=/(iPad)/gi.test(t);return!!e&&(i?t.match(/cpu os (\d*)/)[1]<9:t.match(/iphone os (\d*)/)[1]<9)},deepCopy:function(t){return JSON.parse(JSON.stringify(t))},isObjFunc:function(t,e){return Object.prototype.toString.call(t)==="[object "+e+"]"},isType:function(t){return Object.prototype.toString.call(t).split(" ")[1].replace("]","").toLowerCase()}};function e(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};if(!(this instanceof e))return new e(t);this.ops=j.extend({width:500,height:500,backgroundColor:""},t),this.canvas=null,this.ctx=null,this.queue=[],this.fn={success:function(){},error:function(){}},this.data={textId:0,text:{},bgConfig:null},this._init()}return e.prototype._init=function(){this.canvas=document.createElement("canvas"),this.canvas.width=this.ops.width,this.canvas.height=this.ops.height,this.ctx=this.canvas.getContext("2d"),this.ctx.save(),this.ops.backgroundColor&&this.setBgColor(this.ops.backgroundColor)},e.prototype.background=function(t){var e=this,i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{type:"origin"};if(t||this.data.bgConfig)return t?(i.image=t,this.data.bgConfig=i):i=this.data.bgConfig,this.queue.push(function(){i.color&&e.setBgColor(i.color),j.getImage(i.image,function(t){e._background(t,i)},e.fn.error)}),this;console.error("mcanvas error : the init background must has a image.")},e.prototype.setBgColor=function(t){this.ctx.fillStyle=t,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)},e.prototype._getBgAlign=function(t,e,i,o){var n;return"string"==typeof t?"50%"==t||"center"==t?n=Math.abs((e-i/o)/2):"100%"==t?n=Math.abs(e-i/o):"0%"==t&&(n=0):n="number"==typeof t?t:0,n},e.prototype._background=function(t,e){var i,o,n,a,r,s,h,c,l,d=this._getSize(t),p=d.iw,f=d.ih,u=p/f,g=this.canvas.width/this.canvas.height;switch(e.type){case"crop":l=g<u?(n=f*g,a=f,this.canvas.height/f):(a=(n=p)/g,this.canvas.width/p),i=this._getBgAlign(e.left,p,this.canvas.width,l),o=this._getBgAlign(e.top,f,this.canvas.height,l),s=r=0,c=this.canvas.height,h=this.canvas.width;break;case"contain":o=i=0,n=p,a=f,g<u?(c=(h=this.canvas.width)/u,r=e.left||0,s=e.top||0==e.top?e.top:(this.canvas.height-c)/2):(h=(c=this.canvas.height)*u,s=e.top||0,r=e.left||0==e.left?e.left:(this.canvas.width-h)/2);break;case"origin":i=o=0,n=this.canvas.width=p,a=this.canvas.height=f,r=s=0,h=this.canvas.width,c=this.canvas.height;break;default:return void console.error("mcanvas error:background type error!")}this.ctx.drawImage(t,i,o,n,a,r,s,h,c),this._next()},e.prototype.rect=function(p){var f=this;return this.queue.push(function(){var t=p.fillColor,e=void 0===t?"#fff":t,i=p.strokeColor,o=void 0===i?e:i,n=p.strokeWidth,a=void 0===n?0:n,r=f.canvas.width,s=f.canvas.height,h=f._get(r,0,p.width||0,"pos")-2*a,c=f._get(s,0,p.height||0,"pos")-2*a,l=f._get(r,h,p.x||0,"pos")+a/2,d=f._get(s,c,p.y||0,"pos")+a/2;f.ctx.lineWidth=a,f.ctx.fillStyle=e,f.ctx.strokeStyle=o,f.ctx.beginPath(),f.ctx.strokeRect(l,d,h,c),f.ctx.fillRect(l,d,h,c),f.ctx.closePath(),f._resetCtx()._next()}),this},e.prototype.circle=function(d){var p=this;return this.queue.push(function(){var t=d.fillColor,e=void 0===t?"#fff":t,i=d.strokeColor,o=void 0===i?e:i,n=d.strokeWidth,a=void 0===n?0:n,r=p.canvas.width,s=p.canvas.height,h=p._get(r,0,d.r||0,"pos")-2*a,c=p._get(r,2*h,d.x||0,"pos")+a/2+h,l=p._get(s,2*h,d.y||0,"pos")+a/2+h;p.ctx.beginPath(),p.ctx.arc(c,l,h,0,2*Math.PI,!1),p.ctx.fillStyle=e,p.ctx.fill(),p.ctx.strokeStyle=o,p.ctx.lineWidth=a,p.ctx.stroke(),p.ctx.closePath(),p._resetCtx()._next()}),this},e.prototype._resetCtx=function(){return this.ctx.setTransform(1,0,0,1,0,0),this.ctx.restore(),this},e.prototype.watermark=function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"",e=1<arguments.length?arguments[1]:void 0;if(t){var i=e.width,o=void 0===i?"40%":i,n=e.pos,a=void 0===n?"rightbottom":n,r=e.margin,s=void 0===r?20:r,h={x:0,y:0,scale:1,rotate:0};switch(a){case"leftTop":h.x="left:".concat(s),h.y="top:".concat(s);break;case"leftBottom":h.x="left:".concat(s),h.y="bottom:".concat(s);break;case"rightTop":h.x="right:".concat(s),h.y="top:".concat(s);break;case"rightBottom":h.x="right:".concat(s),h.y="bottom:".concat(s)}return this.add(t,{width:o,pos:h}),this}console.error("mcanvas error : there is not image of watermark.")},e.prototype.add=function(){var i=this,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"",e=1<arguments.length?arguments[1]:void 0,o={width:"100%",crop:{x:0,y:0,width:"100%",height:"100%"},pos:{x:0,y:0,scale:1,rotate:0}};return j.isArr(t)||(t=[{image:t,options:e}]),t.forEach(function(e){i.queue.push(function(){j.getImage(e.image,function(t){i._add(t,i._handleOps(j.extend(o,e.options),t))},i.fn.error)})}),this},e.prototype._add=function(t,e){0==e.width&&console.warn("mcanvas warn: the width of mc-element is zero");var i,o,n,a,r,s,h,c,l,d,p,f=this._getSize(t),u=f.iw,g=f.ih,y=e.crop,x=y.x,v=y.y,w=y.width,m=y.height,b=w/m,_=document.createElement("canvas"),S=_.getContext("2d"),C=g<u?u/g:g/u,O=5<1.4*C?5:1.4*C;if(_.width=w*O,_.height=m*O,j.isIos8()&&(2096<_.width||2096<_.height)?p=1<b?2096/_.width:2096/_.height:(4096<_.width||4096<_.height)&&(p=1<b?4096/_.width:4096/_.height),r=-Math.round(w/2),s=-Math.round(m/2),h=w,c=Math.round(w/b),p){var I=k([_.width,_.height,r,s,h,c].map(function(t){return Math.round(t*p)}),6);_.width=I[0],_.height=I[1],r=I[2],s=I[3],h=I[4],c=I[5]}S.translate(_.width/2,_.height/2),S.rotate(e.pos.rotate),S.drawImage(t,x,v,w,m,r,s,h,c),a=(n=e.width*O)/b,d=(l=(O-1)*e.width/2)/b,i=e.pos.x+n*(1-e.pos.scale)/2-l,o=e.pos.y+a*(1-e.pos.scale)/2-d,n*=e.pos.scale,a*=e.pos.scale,this.ctx.drawImage(_,i,o,n,a),_=S=null,this._next()},e.prototype._getSize=function(t){var e,i;return i="IMG"===t.tagName?(e=t.naturalWidth,t.naturalHeight):"CANVAS"===t.tagName?(e=t.width,t.height):(e=t.offsetWidth,t.offsetHeight),{iw:e,ih:i}},e.prototype._handleOps=function(t,e){var i,o,n=this.canvas.width,a=this.canvas.height,r=this._getSize(e),s=r.iw,h=r.ih,c=s/h,l=this._get(n,s,t.width,"pos"),d=t.crop,p=d.x,f=d.y,u=d.width,g=d.height,y={};y.width=this._get(n,s,u,"crop"),y.height=this._get(a,h,g,"crop"),y.x=this._get(s,y.width,p,"crop"),y.y=this._get(h,y.height,f,"crop"),y.x>s&&(y.x=s),y.y>h&&(y.y=h),i=s-y.x,o=h-y.y,y.width>i&&(y.width=i),y.height>o&&(y.height=o);var x=t.pos,v=x.x,w=x.y,m=x.rotate,b=x.scale;return{width:l,crop:y,pos:{x:this._get(n,l,v,"pos"),y:this._get(a,l/c,w,"pos"),scale:b,rotate:parseFloat(m)*Math.PI/180}}},e.prototype.text=function(){var r=this,s=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"",h=1<arguments.length?arguments[1]:void 0,c="helvetica neue,hiragino sans gb,Microsoft YaHei,arial,tahoma,sans-serif",l=this.canvas.width/20;return this.queue.push(function(){var t={color:"#000",type:"fill",lineWidth:1,shadow:{color:null,blur:0,offsetX:0,offsetY:0}},e={width:300,align:"left",smallStyle:d({font:"".concat(.8*l,"px ").concat(c),lineHeight:.9*l},j.deepCopy(t)),normalStyle:d({font:"".concat(l,"px ").concat(c),lineHeight:1.1*l,type:"fill"},j.deepCopy(t)),largeStyle:d({font:"".concat(1.3*l,"px ").concat(c),lineHeight:1.4*l},j.deepCopy(t)),pos:{x:0,y:0,rotate:0}};e=j.extend(e,h);var i,o=r._parse(s),n=0;o.map(function(t){t.size>n&&(n=t.size,i=t.type)});var a=parseInt(e["".concat(i,"Style")].font);a&&e.width<a&&(e.width=a),r._text(o,e),r._resetCtx()._next()}),this},e.prototype._parse=function(t){for(var e=t.split(/<s>|<b>/),i=[],o=0;o<e.length;o++){var n=e[o];if(/<\/s>|<\/b>/.test(n)){var a=/<\/s>/.test(n)?"</s>":"</b>",r=/<\/s>/.test(n)?"small":"large",s=e[o].split(a);i.push({type:r,text:s[0],size:"small"==r?0:2}),s[1]&&i.push({type:"normal",text:s[1],size:1})}else e[o]&&i.push({text:e[o],type:"normal",size:1})}return i},e.prototype._text=function(t,r){var s=this;this.data.textId++,this.data.text[this.data.textId]={},r.width=this._get(this.canvas.width,0,r.width,"pos");var h,e,i,o,c=1,l=0,d=(e=r,o=0,t.forEach(function(t){i=e["".concat(t.type,"Style")].lineHeight,o<i&&(o=i)}),o),p=this._get(this.canvas.width,r.width,0,"pos"),f=this._get(this.canvas.height,0,0,"pos")+d;this.data.text[this.data.textId][c]={data:[],lineWidth:0},t.forEach(function(t){h=r["".concat(t.type,"Style")],s.ctx.font=h.font;var e=s.ctx.measureText(t.text).width,i=t.text.replace(/<br>/g,"|");if(l+e>r.width||-1!==i.indexOf("|"))for(var o=0,n=i.length;o<n;o++){var a=i[o];e=s.ctx.measureText(a).width,(l+e>r.width||"|"==a)&&(l=0,p=s._get(s.canvas.width,r.width,0,"pos"),f+=d,c+=1,s.data.text[s.data.textId][c]={data:[],lineWidth:0},"|"==a)||(s.data.text[s.data.textId][c].data.push({context:a,x:p,y:f,style:h,width:e}),l+=e,p+=e,s.data.text[s.data.textId][c].lineWidth=l)}else s.data.text[s.data.textId][c].data.push({context:i,x:p,y:f,style:h,width:e}),l+=e,p+=e,s.data.text[s.data.textId][c].lineWidth=l});var n,a,u=document.createElement("canvas"),g=u.getContext("2d"),y=this._get(this.canvas.width,r.width,r.pos.x,"pos"),x=this._get(this.canvas.height,0,r.pos.y,"pos");n=u.width=r.width,a=u.height=this._getTextRectHeight(c),j.forin(this.data.text[this.data.textId],function(t,e){var i=0;e.lineWidth<r.width&&("center"==r.align?i=(r.width-e.lineWidth)/2:"right"==r.align&&(i=r.width-e.lineWidth)),e.data.forEach(function(t){t.x+=i,s._fillText(g,t)})});var v=y+n/2,w=x+a/2;this.ctx.translate(v,w),this.ctx.rotate(parseFloat(r.pos.rotate)*Math.PI/180),this.ctx.drawImage(u,-n/2,-a/2,n,a)},e.prototype._fillText=function(t,e){var i=e.context,o=e.x,n=e.y,a=e.style,r=a.align,s=a.lineWidth,h=a.shadow,c=h.color,l=h.blur,d=h.offsetX,p=h.offsetY;if(t.font=a.font,t.textAlign=r,t.textBaseline="alphabetic",t.lineWidth=s,t.shadowColor=c,t.shadowBlur=l,t.shadowOffsetX=d,t.shadowOffsetY=p,a.gradient){var f,u,g,y,x=a.gradient,v=x.type,w=x.colorStop;y=(g=1==v?(u=n,(f=o)+e.width):(f=o,u=n-a.lineHeight,o),n);var m=t.createLinearGradient(f,u,g,y),b=w.length||0;j.forin(w,function(t,e){m.addColorStop(1/b*(+t+1),e)}),t["".concat(a.type,"Style")]=m}else t["".concat(a.type,"Style")]=a.color;t["".concat(a.type,"Text")](i,o,n),this._resetCtx()},e.prototype._getTextRectHeight=function(t){var e=this.data.text[this.data.textId][t].data[0];return e.y+e.style.lineHeight},e.prototype._get=function(t,e,i,o){var n=i;if("string"==typeof i)if(-1!==i.indexOf(":")&&"pos"==o){var a=i.split(":");switch(a[0]){case"left":case"top":n=+a[1].replace("px","");break;case"right":case"bottom":n=t-+a[1].replace("px","")-e}}else n=-1!==i.indexOf("px")?+i.replace("px",""):-1!==i.indexOf("%")?"crop"==o?e*+i.replace("%","")/100:t*+i.replace("%","")/100:"center"==i?(t-e)/2:"origin"==i?e:+i;return Math.round(n)},e.prototype.draw=function(t){var e,i=this,o={type:"jpg",quality:.9,success:function(){},error:function(){}};return"function"==typeof t?o.success=t:"jpg"==(o=j.extend(o,t)).type&&(o.type="jpeg"),this.fn.error=o.error,this.fn.success=function(){setTimeout(function(){e=i.canvas.toDataURL("image/".concat(o.type),o.quality),o.success(e)},0)},this._next(),this},e.prototype._next=function(){0<this.queue.length?this.queue.shift()():this.fn.success()},e.prototype.clear=function(){return this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this},e});
//# sourceMappingURL=mcanvas.min.js.map
